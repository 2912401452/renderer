!(function(t, i) {
  'object' == typeof exports && 'undefined' != typeof module
    ? i(exports)
    : 'function' == typeof define && define.amd
    ? define(['exports'], i)
    : i(
        ((t =
          'undefined' != typeof globalThis
            ? globalThis
            : t || self).renderer = {}),
      );
})(this, function(t) {
  'use strict';
  function i(t, i, e, r, a, n, s) {
    try {
      var o = t[n](s),
        h = o.value;
    } catch (t) {
      return void e(t);
    }
    o.done ? i(h) : Promise.resolve(h).then(r, a);
  }
  function e(t, i) {
    if (!(t instanceof i))
      throw new TypeError('Cannot call a class as a function');
  }
  function r(t, i) {
    for (var e = 0; i.length > e; e++) {
      var r = i[e];
      (r.enumerable = r.enumerable || !1),
        (r.configurable = !0),
        'value' in r && (r.writable = !0),
        Object.defineProperty(t, r.key, r);
    }
  }
  function a(t, i, e) {
    return i && r(t.prototype, i), e && r(t, e), t;
  }
  function n(t, i) {
    if ('function' != typeof i && null !== i)
      throw new TypeError('Super expression must either be null or a function');
    (t.prototype = Object.create(i && i.prototype, {
      constructor: { value: t, writable: !0, configurable: !0 },
    })),
      i && o(t, i);
  }
  function s(t) {
    return (
      (s = Object.setPrototypeOf
        ? Object.getPrototypeOf
        : function(t) {
            return t.__proto__ || Object.getPrototypeOf(t);
          }),
      s(t)
    );
  }
  function o(t, i) {
    return (
      (o =
        Object.setPrototypeOf ||
        function(t, i) {
          return (t.__proto__ = i), t;
        }),
      o(t, i)
    );
  }
  function h(t, i) {
    if (i && ('object' == typeof i || 'function' == typeof i)) return i;
    if (void 0 !== i)
      throw new TypeError(
        'Derived constructors may only return object or undefined',
      );
    return (function(t) {
      if (void 0 === t)
        throw new ReferenceError(
          "this hasn't been initialised - super() hasn't been called",
        );
      return t;
    })(t);
  }
  function l(t) {
    var i = (function() {
      if ('undefined' == typeof Reflect || !Reflect.construct) return !1;
      if (Reflect.construct.sham) return !1;
      if ('function' == typeof Proxy) return !0;
      try {
        return (
          Boolean.prototype.valueOf.call(
            Reflect.construct(Boolean, [], function() {}),
          ),
          !0
        );
      } catch (t) {
        return !1;
      }
    })();
    return function() {
      var e,
        r = s(t);
      if (i) {
        var a = s(this).constructor;
        e = Reflect.construct(r, arguments, a);
      } else e = r.apply(this, arguments);
      return h(this, e);
    };
  }
  function u(t) {
    return (
      (function(t) {
        if (Array.isArray(t)) return c(t);
      })(t) ||
      (function(t) {
        if (
          ('undefined' != typeof Symbol && null != t[Symbol.iterator]) ||
          null != t['@@iterator']
        )
          return Array.from(t);
      })(t) ||
      (function(t, i) {
        if (!t) return;
        if ('string' == typeof t) return c(t, i);
        var e = Object.prototype.toString.call(t).slice(8, -1);
        'Object' === e && t.constructor && (e = t.constructor.name);
        if ('Map' === e || 'Set' === e) return Array.from(t);
        if (
          'Arguments' === e ||
          /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)
        )
          return c(t, i);
      })(t) ||
      (function() {
        throw new TypeError(
          'Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.',
        );
      })()
    );
  }
  function c(t, i) {
    (null == i || i > t.length) && (i = t.length);
    for (var e = 0, r = Array(i); i > e; e++) r[e] = t[e];
    return r;
  }
  var f = 1e-6,
    g = 'undefined' != typeof Float32Array ? Float32Array : Array;
  function v() {
    var t = new g(16);
    return (
      g != Float32Array &&
        ((t[1] = 0),
        (t[2] = 0),
        (t[3] = 0),
        (t[4] = 0),
        (t[6] = 0),
        (t[7] = 0),
        (t[8] = 0),
        (t[9] = 0),
        (t[11] = 0),
        (t[12] = 0),
        (t[13] = 0),
        (t[14] = 0)),
      (t[0] = 1),
      (t[5] = 1),
      (t[10] = 1),
      (t[15] = 1),
      t
    );
  }
  function d(t, i, e) {
    var r = i[0],
      a = i[1],
      n = i[2],
      s = i[3],
      o = i[4],
      h = i[5],
      l = i[6],
      u = i[7],
      c = i[8],
      f = i[9],
      g = i[10],
      v = i[11],
      d = i[12],
      m = i[13],
      p = i[14],
      x = i[15],
      _ = e[0],
      E = e[1],
      M = e[2],
      y = e[3];
    return (
      (t[0] = _ * r + E * o + M * c + y * d),
      (t[1] = _ * a + E * h + M * f + y * m),
      (t[2] = _ * n + E * l + M * g + y * p),
      (t[3] = _ * s + E * u + M * v + y * x),
      (t[4] =
        (_ = e[4]) * r + (E = e[5]) * o + (M = e[6]) * c + (y = e[7]) * d),
      (t[5] = _ * a + E * h + M * f + y * m),
      (t[6] = _ * n + E * l + M * g + y * p),
      (t[7] = _ * s + E * u + M * v + y * x),
      (t[8] =
        (_ = e[8]) * r + (E = e[9]) * o + (M = e[10]) * c + (y = e[11]) * d),
      (t[9] = _ * a + E * h + M * f + y * m),
      (t[10] = _ * n + E * l + M * g + y * p),
      (t[11] = _ * s + E * u + M * v + y * x),
      (t[12] =
        (_ = e[12]) * r + (E = e[13]) * o + (M = e[14]) * c + (y = e[15]) * d),
      (t[13] = _ * a + E * h + M * f + y * m),
      (t[14] = _ * n + E * l + M * g + y * p),
      (t[15] = _ * s + E * u + M * v + y * x),
      t
    );
  }
  function m(t, i, e, r) {
    var a,
      n,
      s,
      o,
      h,
      l,
      u,
      c,
      g,
      v,
      d,
      m,
      p,
      x,
      _,
      E,
      M,
      y,
      R,
      b,
      T,
      A,
      w,
      F,
      P = r[0],
      C = r[1],
      U = r[2],
      B = Math.hypot(P, C, U);
    return f > B
      ? null
      : ((P *= B = 1 / B),
        (C *= B),
        (U *= B),
        (a = Math.sin(e)),
        (h = i[1]),
        (l = i[2]),
        (u = i[3]),
        (g = i[5]),
        (v = i[6]),
        (d = i[7]),
        (p = i[9]),
        (x = i[10]),
        (_ = i[11]),
        (R = P * C * (s = 1 - (n = Math.cos(e))) - U * a),
        (b = C * C * s + n),
        (T = U * C * s + P * a),
        (A = P * U * s + C * a),
        (w = C * U * s - P * a),
        (F = U * U * s + n),
        (t[0] =
          (o = i[0]) * (E = P * P * s + n) +
          (c = i[4]) * (M = C * P * s + U * a) +
          (m = i[8]) * (y = U * P * s - C * a)),
        (t[1] = h * E + g * M + p * y),
        (t[2] = l * E + v * M + x * y),
        (t[3] = u * E + d * M + _ * y),
        (t[4] = o * R + c * b + m * T),
        (t[5] = h * R + g * b + p * T),
        (t[6] = l * R + v * b + x * T),
        (t[7] = u * R + d * b + _ * T),
        (t[8] = o * A + c * w + m * F),
        (t[9] = h * A + g * w + p * F),
        (t[10] = l * A + v * w + x * F),
        (t[11] = u * A + d * w + _ * F),
        i !== t &&
          ((t[12] = i[12]), (t[13] = i[13]), (t[14] = i[14]), (t[15] = i[15])),
        t);
  }
  Math.hypot ||
    (Math.hypot = function() {
      for (var t = 0, i = arguments.length; i--; )
        t += arguments[i] * arguments[i];
      return Math.sqrt(t);
    });
  var p = function(t, i, e, r, a) {
    var n,
      s = 1 / Math.tan(i / 2);
    return (
      (t[0] = s / e),
      (t[1] = 0),
      (t[2] = 0),
      (t[3] = 0),
      (t[4] = 0),
      (t[5] = s),
      (t[6] = 0),
      (t[7] = 0),
      (t[8] = 0),
      (t[9] = 0),
      (t[11] = -1),
      (t[12] = 0),
      (t[13] = 0),
      (t[15] = 0),
      null != a && a !== 1 / 0
        ? ((t[10] = (a + r) * (n = 1 / (r - a))), (t[14] = 2 * a * r * n))
        : ((t[10] = -1), (t[14] = -2 * r)),
      t
    );
  };
  function x(t, i, e) {
    var r = new g(3);
    return (r[0] = t), (r[1] = i), (r[2] = e), r;
  }
  (_ = new g(3)),
    g != Float32Array && ((_[0] = 0), (_[1] = 0), (_[2] = 0)),
    (E = _);
  var _,
    E,
    M = (function() {
      for (var t = [], i = 0; 256 > i; i++)
        t[i] = (16 > i ? '0' : '') + i.toString(16);
      return function() {
        var i = (4294967295 * Math.random()) | 0,
          e = (4294967295 * Math.random()) | 0,
          r = (4294967295 * Math.random()) | 0,
          a = (4294967295 * Math.random()) | 0;
        return (
          t[255 & i] +
          t[(i >> 8) & 255] +
          t[(i >> 16) & 255] +
          t[(i >> 24) & 255] +
          '-' +
          t[255 & e] +
          t[(e >> 8) & 255] +
          '-' +
          t[((e >> 16) & 15) | 64] +
          t[(e >> 24) & 255] +
          '-' +
          t[(63 & r) | 128] +
          t[(r >> 8) & 255] +
          '-' +
          t[(r >> 16) & 255] +
          t[(r >> 24) & 255] +
          t[255 & a] +
          t[(a >> 8) & 255] +
          t[(a >> 16) & 255] +
          t[(a >> 24) & 255]
        ).toUpperCase();
      };
    })();
  function y(t) {
    return 0 == (t & (t - 1)) && 0 !== t;
  }
  function R(t) {
    return Math.pow(2, Math.floor(Math.log(t) / Math.LN2));
  }
  function b(t, i) {
    return Math.sqrt(
      Math.pow(t[0] - i[0], 2) +
        Math.pow(t[1] - i[1], 2) +
        Math.pow(t[2] - i[2], 2),
    );
  }
  var T = (function() {
      function t(i) {
        e(this, t),
          (this.uuid = void 0),
          (this.gl = void 0),
          (this.projMatrix = void 0),
          (this.viewMatrix = void 0),
          (this.modelMatrix = void 0),
          (this.program = void 0),
          (this.position = void 0),
          (this.cameraDistance = void 0),
          (this.uuid = M()),
          (this.gl = i.gl),
          (this.position = (null == i ? void 0 : i.position) || [0, 0, 0]),
          (this.rotation = (null == i ? void 0 : i.rotation) || [0, 0, 0]),
          (this.scale = (null == i ? void 0 : i.scale) || [1, 1, 1]),
          (this.childrens = []),
          this.setMeshMatrixs(),
          (this.modelMatrix = this.initModelMatrix());
      }
      return (
        a(t, [
          {
            key: 'setMeshMatrixs',
            value: function() {
              this.setTranslete(this.position),
                this.setRotate(),
                this.setScaleMatrix();
            },
          },
          {
            key: 'setTranslete',
            value: function(t) {
              (this.translateMatrix = v()),
                (function(t, i, e) {
                  var r,
                    a,
                    n,
                    s,
                    o,
                    h,
                    l,
                    u,
                    c,
                    f,
                    g,
                    v,
                    d = e[0],
                    m = e[1],
                    p = e[2];
                  i === t
                    ? ((t[12] = i[0] * d + i[4] * m + i[8] * p + i[12]),
                      (t[13] = i[1] * d + i[5] * m + i[9] * p + i[13]),
                      (t[14] = i[2] * d + i[6] * m + i[10] * p + i[14]),
                      (t[15] = i[3] * d + i[7] * m + i[11] * p + i[15]))
                    : ((a = i[1]),
                      (n = i[2]),
                      (s = i[3]),
                      (o = i[4]),
                      (h = i[5]),
                      (l = i[6]),
                      (u = i[7]),
                      (c = i[8]),
                      (f = i[9]),
                      (g = i[10]),
                      (v = i[11]),
                      (t[0] = r = i[0]),
                      (t[1] = a),
                      (t[2] = n),
                      (t[3] = s),
                      (t[4] = o),
                      (t[5] = h),
                      (t[6] = l),
                      (t[7] = u),
                      (t[8] = c),
                      (t[9] = f),
                      (t[10] = g),
                      (t[11] = v),
                      (t[12] = r * d + o * m + c * p + i[12]),
                      (t[13] = a * d + h * m + f * p + i[13]),
                      (t[14] = n * d + l * m + g * p + i[14]),
                      (t[15] = s * d + u * m + v * p + i[15]));
                })(this.translateMatrix, this.translateMatrix, t),
                this.rotateMatrix &&
                  this.scaleMatrix &&
                  this.updateModelMatrix();
            },
          },
          {
            key: 'setRotate',
            value: function(t) {
              t && (this.rotation = u(t)),
                (this.rotateMatrix = v()),
                m(
                  this.rotateMatrix,
                  this.rotateMatrix,
                  this.rotation[0],
                  x(1, 0, 0),
                ),
                m(
                  this.rotateMatrix,
                  this.rotateMatrix,
                  this.rotation[1],
                  x(0, 1, 0),
                ),
                m(
                  this.rotateMatrix,
                  this.rotateMatrix,
                  this.rotation[2],
                  x(0, 0, 1),
                ),
                this.translateMatrix &&
                  this.scaleMatrix &&
                  this.updateModelMatrix();
            },
          },
          {
            key: 'setScaleMatrix',
            value: function() {
              this.scaleMatrix = v();
            },
          },
          {
            key: 'initModelMatrix',
            value: function() {
              return d(
                v(),
                this.scaleMatrix,
                d(v(), this.translateMatrix, this.rotateMatrix),
              );
            },
          },
          {
            key: 'updateModelMatrix',
            value: function() {
              var t;
              d(
                this.modelMatrix,
                this.scaleMatrix,
                d(v(), this.translateMatrix, this.rotateMatrix),
              );
              var i =
                (null == this || null === (t = this.parent) || void 0 === t
                  ? void 0
                  : t.modelMatrix) || v();
              d(this.modelMatrix, i, this.modelMatrix),
                this.childrens.map(function(t) {
                  return t.updateModelMatrix();
                });
            },
          },
          {
            key: 'rotate',
            value: function(t) {
              (this.rotation[0] += t[0]),
                (this.rotation[1] += t[1]),
                (this.rotation[2] += t[2]),
                (function(t, i, e) {
                  var r = Math.sin(e),
                    a = Math.cos(e),
                    n = i[4],
                    s = i[5],
                    o = i[6],
                    h = i[7],
                    l = i[8],
                    u = i[9],
                    c = i[10],
                    f = i[11];
                  i !== t &&
                    ((t[0] = i[0]),
                    (t[1] = i[1]),
                    (t[2] = i[2]),
                    (t[3] = i[3]),
                    (t[12] = i[12]),
                    (t[13] = i[13]),
                    (t[14] = i[14]),
                    (t[15] = i[15])),
                    (t[4] = n * a + l * r),
                    (t[5] = s * a + u * r),
                    (t[6] = o * a + c * r),
                    (t[7] = h * a + f * r),
                    (t[8] = l * a - n * r),
                    (t[9] = u * a - s * r),
                    (t[10] = c * a - o * r),
                    (t[11] = f * a - h * r);
                })(this.rotateMatrix, this.rotateMatrix, t[0]),
                (function(t, i, e) {
                  var r = Math.sin(e),
                    a = Math.cos(e),
                    n = i[0],
                    s = i[1],
                    o = i[2],
                    h = i[3],
                    l = i[8],
                    u = i[9],
                    c = i[10],
                    f = i[11];
                  i !== t &&
                    ((t[4] = i[4]),
                    (t[5] = i[5]),
                    (t[6] = i[6]),
                    (t[7] = i[7]),
                    (t[12] = i[12]),
                    (t[13] = i[13]),
                    (t[14] = i[14]),
                    (t[15] = i[15])),
                    (t[0] = n * a - l * r),
                    (t[1] = s * a - u * r),
                    (t[2] = o * a - c * r),
                    (t[3] = h * a - f * r),
                    (t[8] = n * r + l * a),
                    (t[9] = s * r + u * a),
                    (t[10] = o * r + c * a),
                    (t[11] = h * r + f * a);
                })(this.rotateMatrix, this.rotateMatrix, t[1]),
                (function(t, i, e) {
                  var r = Math.sin(e),
                    a = Math.cos(e),
                    n = i[0],
                    s = i[1],
                    o = i[2],
                    h = i[3],
                    l = i[4],
                    u = i[5],
                    c = i[6],
                    f = i[7];
                  i !== t &&
                    ((t[8] = i[8]),
                    (t[9] = i[9]),
                    (t[10] = i[10]),
                    (t[11] = i[11]),
                    (t[12] = i[12]),
                    (t[13] = i[13]),
                    (t[14] = i[14]),
                    (t[15] = i[15])),
                    (t[0] = n * a + l * r),
                    (t[1] = s * a + u * r),
                    (t[2] = o * a + c * r),
                    (t[3] = h * a + f * r),
                    (t[4] = l * a - n * r),
                    (t[5] = u * a - s * r),
                    (t[6] = c * a - o * r),
                    (t[7] = f * a - h * r);
                })(this.rotateMatrix, this.rotateMatrix, t[2]),
                this.updateModelMatrix();
            },
          },
          {
            key: 'add',
            value: function(t) {
              this.hasChildren(t) ||
                (t.parent && t.parent.remove(t),
                t.setParent(this),
                this.childrens.push(t));
            },
          },
          {
            key: 'hasChildren',
            value: function(t) {
              return (
                !!t.uuid &&
                this.childrens.filter(function(i) {
                  return i.uuid === t.uuid;
                }).length > 0
              );
            },
          },
          {
            key: 'setParent',
            value: function(t) {
              this.parent = t;
            },
          },
          {
            key: 'remove',
            value: function(t) {
              this.childrens = this.childrens.filter(function(i) {
                return i.uuid === t && i.setParent(void 0), i.uuid !== t;
              });
            },
          },
        ]),
        t
      );
    })(),
    A = (function(t) {
      n(r, t);
      var i = l(r);
      function r(t) {
        var a;
        return (
          e(this, r),
          ((a = i.call(this, t)).type = 'Scene'),
          (a.gl = void 0),
          (a.camera = void 0),
          (a.passList = void 0),
          (a.children = []),
          (a.renderer = t.renderer),
          (a.gl = a.renderer.gl),
          (a.camera = t.camera),
          (a.passList = []),
          a
        );
      }
      return (
        a(r, [
          {
            key: 'add',
            value: function(t) {
              t.init(this.gl, this.camera),
                this.hasChildren(t) ||
                  (t.parent && t.parent.remove(t),
                  t.setParent(this),
                  this.children.push(t),
                  (t.scene = this));
            },
          },
          {
            key: 'setCamera',
            value: function(t) {
              this.camera = t;
            },
          },
          { key: 'setRenderer', value: function() {} },
          {
            key: 'addPass',
            value: function(t) {
              t.init(this.gl), this.passList.push(t);
            },
          },
          {
            key: 'drawElements',
            value: function() {
              var t = this,
                i = [],
                e = [];
              this.children.forEach(function(r) {
                var a;
                (r.cameraDistance = b(r.position, t.camera.position)),
                  (null == r || null === (a = r.material) || void 0 === a
                  ? void 0
                  : a.transparent)
                    ? e.push(r)
                    : i.push(r);
              }),
                i.sort(function(t, i) {
                  return t.cameraDistance - i.cameraDistance;
                }),
                i.map(function(i) {
                  return i.draw(t.camera);
                }),
                this.gl.depthMask(!1),
                e.map(function(i) {
                  return i.draw(t.camera);
                }),
                this.gl.depthMask(!0);
            },
          },
          {
            key: 'renderScene',
            value: function() {
              if (this.passList.length > 0)
                for (var t = 0; this.passList.length > t; t++) {
                  var i = this.passList[t];
                  this.gl.bindFramebuffer(this.gl.FRAMEBUFFER, i.framebuffer),
                    this.gl.clear(
                      this.gl.COLOR_BUFFER_BIT | this.gl.DEPTH_BUFFER_BIT,
                    ),
                    0 === t && this.drawElements(),
                    this.gl.bindFramebuffer(this.gl.FRAMEBUFFER, null),
                    i.drawPass();
                }
              else
                this.gl.clear(
                  this.gl.COLOR_BUFFER_BIT | this.gl.DEPTH_BUFFER_BIT,
                ),
                  this.drawElements();
            },
          },
        ]),
        r
      );
    })(T),
    w = (function() {
      function t(i) {
        e(this, t),
          (this.eye = (null == i ? void 0 : i.eye) || [1, 1, 1]),
          (this.target = (null == i ? void 0 : i.target) || [0, 0, 0]),
          (this.up = (null == i ? void 0 : i.up) || [0, 1, 0]),
          (this.viewMatrix = v()),
          this.initViewMatrix();
      }
      return (
        a(t, [
          {
            key: 'initViewMatrix',
            value: function() {
              !(function(t, i, e, r) {
                var a,
                  n,
                  s,
                  o,
                  h,
                  l,
                  u,
                  c,
                  g,
                  v,
                  d = i[0],
                  m = i[1],
                  p = i[2],
                  x = r[0],
                  _ = r[1],
                  E = r[2],
                  M = e[0],
                  y = e[1],
                  R = e[2];
                f > Math.abs(d - M) &&
                f > Math.abs(m - y) &&
                f > Math.abs(p - R)
                  ? (function(t) {
                      (t[0] = 1),
                        (t[1] = 0),
                        (t[2] = 0),
                        (t[3] = 0),
                        (t[4] = 0),
                        (t[5] = 1),
                        (t[6] = 0),
                        (t[7] = 0),
                        (t[8] = 0),
                        (t[9] = 0),
                        (t[10] = 1),
                        (t[11] = 0),
                        (t[12] = 0),
                        (t[13] = 0),
                        (t[14] = 0),
                        (t[15] = 1);
                    })(t)
                  : ((v =
                      1 / Math.hypot((u = d - M), (c = m - y), (g = p - R))),
                    (v = Math.hypot(
                      (a = _ * (g *= v) - E * (c *= v)),
                      (n = E * (u *= v) - x * g),
                      (s = x * c - _ * u),
                    ))
                      ? ((a *= v = 1 / v), (n *= v), (s *= v))
                      : ((a = 0), (n = 0), (s = 0)),
                    (v = Math.hypot(
                      (o = c * s - g * n),
                      (h = g * a - u * s),
                      (l = u * n - c * a),
                    ))
                      ? ((o *= v = 1 / v), (h *= v), (l *= v))
                      : ((o = 0), (h = 0), (l = 0)),
                    (t[0] = a),
                    (t[1] = o),
                    (t[2] = u),
                    (t[3] = 0),
                    (t[4] = n),
                    (t[5] = h),
                    (t[6] = c),
                    (t[7] = 0),
                    (t[8] = s),
                    (t[9] = l),
                    (t[10] = g),
                    (t[11] = 0),
                    (t[12] = -(a * d + n * m + s * p)),
                    (t[13] = -(o * d + h * m + l * p)),
                    (t[14] = -(u * d + c * m + g * p)),
                    (t[15] = 1));
              })(this.viewMatrix, this.eye, this.target, this.up);
            },
          },
          {
            key: 'getViewMatrix',
            value: function() {
              return this.viewMatrix;
            },
          },
        ]),
        t
      );
    })(),
    F = (function() {
      function t(i) {
        e(this, t),
          (this.position = void 0),
          (this.aspect = void 0),
          (this.fov = (null == i ? void 0 : i.fov) || 40),
          (this.aspect = (null == i ? void 0 : i.aspect) || 1),
          (this.near = (null == i ? void 0 : i.near) || 0.01),
          (this.far = (null == i ? void 0 : i.far) || 100),
          (this.position = (null == i ? void 0 : i.position) || [1, 1, 1]),
          (this.target = (null == i ? void 0 : i.target) || [0, 0, 0]),
          (this.up = (null == i ? void 0 : i.up) || [0, 1, 0]),
          (this.viewPort = new w({
            eye: this.position,
            target: this.target,
            up: this.up,
          })),
          this.initPerspectiveMatrix();
      }
      return (
        a(t, [
          {
            key: 'initPerspectiveMatrix',
            value: function() {
              (this.perspectiveMatrix = v()),
                p(
                  this.perspectiveMatrix,
                  (this.fov * Math.PI) / 180,
                  this.aspect,
                  this.near,
                  this.far,
                );
            },
          },
          {
            key: 'resize',
            value: function(t, i) {
              (this.aspect = t / i), this.updatePerspectiveMatrix();
            },
          },
          {
            key: 'updatePerspectiveMatrix',
            value: function() {
              this.initPerspectiveMatrix();
            },
          },
          {
            key: 'getPerspectiveMatrix',
            value: function() {
              return this.perspectiveMatrix;
            },
          },
          {
            key: 'getViewMatrix',
            value: function() {
              return this.viewPort.getViewMatrix();
            },
          },
        ]),
        t
      );
    })(),
    P = (function() {
      function t(i) {
        e(this, t),
          (this.type = 'Color'),
          (this.r = 1),
          (this.g = 1),
          (this.b = 1),
          (this.a = 1),
          'string' == typeof i
            ? this.handleStringColor(i)
            : i instanceof Array
            ? ((this.r = i[0]),
              (this.g = i[1]),
              (this.b = i[2]),
              (this.a = i[3]))
            : t.isColor(i) &&
              ((this.r = i.r), (this.g = i.g), (this.b = i.b), (this.a = i.a));
      }
      return (
        a(t, [
          {
            key: 'handleStringColor',
            value: function(t) {
              if (t.startsWith('#')) this.handle16Color(t);
              else
                switch (t) {
                  case 'red':
                    (this.r = 1), (this.g = 0), (this.b = 0), (this.a = 1);
                    break;
                  case 'yellow':
                    (this.r = 1), (this.g = 1), (this.b = 0), (this.a = 1);
                    break;
                  case 'blue':
                    (this.r = 0), (this.g = 0), (this.b = 1), (this.a = 1);
                    break;
                  case 'green':
                    (this.r = 0), (this.g = 1), (this.b = 0), (this.a = 1);
                    break;
                  case 'white':
                    (this.r = 1), (this.g = 1), (this.b = 1), (this.a = 1);
                    break;
                  case 'black':
                    (this.r = 0), (this.g = 0), (this.b = 0), (this.a = 1);
                }
            },
          },
          {
            key: 'handle16Color',
            value: function() {
              (this.r = 1), (this.g = 1), (this.b = 1), (this.a = 1);
            },
          },
          {
            key: 'getRGBA',
            value: function() {
              return [this.r, this.g, this.b, this.a];
            },
          },
          {
            key: 'getRGB',
            value: function() {
              return [this.r, this.g, this.b];
            },
          },
        ]),
        t
      );
    })();
  P.isColor = function(t) {
    return !(!t || !t.type || 'Color' !== t.type);
  };
  var C = function(t, i) {
      var e = document.createElement('canvas');
      return U(e, t, i), e;
    },
    U = function(t, i, e) {
      (t.width = i * window.devicePixelRatio),
        (t.height = e * window.devicePixelRatio),
        (t.style.width = i + 'px'),
        (t.style.height = e + 'px');
    },
    B = (function() {
      function t(i) {
        e(this, t),
          (this.gl = void 0),
          (this.wrap = void 0),
          (this.clearColor = void 0),
          (this.canvas = void 0),
          (this.renderPixelWidth = void 0),
          (this.renderPixelHeight = void 0),
          (this.clearColor = new P(i.clearColor)),
          this.initRenderContext(i.wrap),
          this.renderPixelSize();
      }
      return (
        a(t, [
          {
            key: 'initRenderContext',
            value: function(t) {
              if ('string' == typeof t) {
                this.wrap = document.getElementById('wrap');
                var i = this.wrap;
                this.canvas = C(i.clientWidth, i.clientHeight);
              } else if (t instanceof HTMLCanvasElement)
                (this.wrap = t.parentNode), (this.canvas = t);
              else {
                this.wrap = t;
                var e = this.wrap;
                this.canvas = C(e.clientWidth, e.clientHeight);
              }
              this.wrap.appendChild(this.canvas),
                (this.gl = this.canvas.getContext('webgl')),
                this.initGLParams(this.gl);
            },
          },
          {
            key: 'initGLParams',
            value: function(t) {
              var i = this.clearColor.getRGBA();
              t.clearColor(i[0], i[1], i[2], i[3]),
                t.clear(t.COLOR_BUFFER_BIT),
                t.enable(t.DEPTH_TEST),
                t.clear(t.DEPTH_BUFFER_BIT),
                t.enable(t.BLEND),
                t.blendFunc(t.SRC_ALPHA, t.ONE_MINUS_SRC_ALPHA),
                t.enable(t.CULL_FACE),
                t.disable(t.CULL_FACE);
            },
          },
          {
            key: 'renderPixelSize',
            value: function() {
              var t = this.canvas,
                i = t.clientHeight;
              (this.renderPixelWidth = t.clientWidth),
                (this.renderPixelHeight = i);
            },
          },
          {
            key: 'resize',
            value: function() {
              var t = this.wrap;
              U(this.canvas, t.clientWidth, t.clientHeight),
                this.renderPixelSize(),
                this.gl.viewport(
                  0,
                  0,
                  this.gl.canvas.width,
                  this.gl.canvas.height,
                );
            },
          },
        ]),
        t
      );
    })(),
    S = 'undefined' != typeof OffscreenCanvas;
  function k(t) {
    var i = R(t.width),
      e = R(t.height),
      r = (function(t, i) {
        return S
          ? new OffscreenCanvas(t, i)
          : document.createElementNS('http://www.w3.org/1999/xhtml', 'canvas');
      })(i, e);
    return (
      (r.width = i),
      (r.height = e),
      r.getContext('2d').drawImage(t, 0, 0, i, e),
      r
    );
  }
  function D(t) {
    return new Promise(function(i, e) {
      var r = new Image();
      (r.src = t),
        (r.crossOrigin = 'anonymous'),
        (r.onload = function() {
          var t;
          y((t = r).width) && y(t.height)
            ? i({ succeed: !0, img: r })
            : i({ succeed: !0, img: k(r) });
        }),
        (r.onerror = function(t) {
          e({ succeed: !1, img: r });
        });
    });
  }
  var L = (function(t) {
    n(h, t);
    var r,
      s,
      o = l(h);
    function h(t) {
      var i;
      return (
        e(this, h),
        ((i = o.call(this)).color = void 0),
        (i.opacity = 1),
        (i.transparent = !1),
        (i.map = void 0),
        (i.image = void 0),
        (i.texture = void 0),
        (i.color = new P(t.color)),
        void 0 !== t.opacity && (i.opacity = t.opacity),
        void 0 !== t.transparent && (i.transparent = t.transparent),
        (i.map = (null == t ? void 0 : t.map) || void 0),
        i
      );
    }
    return (
      a(h, [
        {
          key: 'init',
          value:
            ((r = regeneratorRuntime.mark(function t(i) {
              var e, r;
              return regeneratorRuntime.wrap(
                function(t) {
                  for (;;)
                    switch ((t.prev = t.next)) {
                      case 0:
                        if (((this.gl = i), !this.map)) {
                          t.next = 8;
                          break;
                        }
                        return (t.next = 4), D(this.map);
                      case 4:
                        (r = (e = t.sent).img),
                          e.succeed && ((this.image = r), this.initTexture());
                      case 8:
                      case 'end':
                        return t.stop();
                    }
                },
                t,
                this,
              );
            })),
            (s = function() {
              var t = this,
                e = arguments;
              return new Promise(function(a, n) {
                var s = r.apply(t, e);
                function o(t) {
                  i(s, a, n, o, h, 'next', t);
                }
                function h(t) {
                  i(s, a, n, o, h, 'throw', t);
                }
                o(void 0);
              });
            }),
            function(t) {
              return s.apply(this, arguments);
            }),
        },
        {
          key: 'initTexture',
          value: function() {
            (this.texture = this.gl.createTexture()),
              this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL, 1),
              this.gl.bindTexture(this.gl.TEXTURE_2D, this.texture),
              this.gl.texParameteri(
                this.gl.TEXTURE_2D,
                this.gl.TEXTURE_MIN_FILTER,
                this.gl.LINEAR,
              ),
              this.gl.texParameteri(
                this.gl.TEXTURE_2D,
                this.gl.TEXTURE_WRAP_S,
                this.gl.REPEAT,
              ),
              this.gl.texParameteri(
                this.gl.TEXTURE_2D,
                this.gl.TEXTURE_WRAP_T,
                this.gl.CLAMP_TO_EDGE,
              ),
              this.gl.texImage2D(
                this.gl.TEXTURE_2D,
                0,
                this.gl.RGBA,
                this.gl.RGBA,
                this.gl.UNSIGNED_BYTE,
                this.image,
              ),
              this.emit('loadImage', {
                texture: this.texture,
                img: this.image,
              });
          },
        },
        { key: 'destroy', value: function() {} },
      ]),
      h
    );
  })(
    (function() {
      function t() {
        e(this, t),
          (this.listeners = void 0),
          (this.gl = void 0),
          (this.program = void 0),
          (this.listeners = {});
      }
      return (
        a(t, [
          {
            key: 'on',
            value: function(t, i) {
              this.listeners[t] || (this.listeners[t] = []),
                this.listeners[t].push(i);
            },
          },
          {
            key: 'emit',
            value: function(t, i) {
              this.listeners[t] &&
                this.listeners[t].map(function(t) {
                  t(i);
                });
            },
          },
          {
            key: 'off',
            value: function(t, i) {
              if (this.listeners[t])
                if (i) {
                  var e = this.listeners[t].indexOf(i);
                  e > -1 && this.listeners[t].splice(e, 1);
                } else this.listeners[t].length = 0;
            },
          },
        ]),
        t
      );
    })(),
  );
  function I(t, i, e) {
    var r = O(t, t.VERTEX_SHADER, i),
      a = O(t, t.FRAGMENT_SHADER, e);
    if (!r || !a) return null;
    var n = t.createProgram();
    if (!n) return null;
    if (
      (t.attachShader(n, r),
      t.attachShader(n, a),
      t.linkProgram(n),
      !t.getProgramParameter(n, t.LINK_STATUS))
    ) {
      var s = t.getProgramInfoLog(n);
      return (
        console.log('Failed to link program: ' + s),
        t.deleteProgram(n),
        t.deleteShader(a),
        t.deleteShader(r),
        null
      );
    }
    return n;
  }
  function O(t, i, e) {
    var r = t.createShader(i);
    if (null == r) return console.log('unable to create shader'), null;
    if (
      (t.shaderSource(r, e),
      t.compileShader(r),
      !t.getShaderParameter(r, t.COMPILE_STATUS))
    ) {
      var a = t.getShaderInfoLog(r);
      return (
        console.log('Failed to compile shader: ' + a), t.deleteShader(r), null
      );
    }
    return r;
  }
  function H(t, i, e, r, a) {
    var n = t.createBuffer();
    n || console.log('failed create vertex buffer'),
      t.bindBuffer(t.ARRAY_BUFFER, n),
      t.bufferData(t.ARRAY_BUFFER, e, t.STATIC_DRAW);
    var s = t.getAttribLocation(a, i);
    return (
      t.vertexAttribPointer(s, r, t.FLOAT, !1, 0, 0),
      t.enableVertexAttribArray(s),
      t.bindBuffer(t.ARRAY_BUFFER, null),
      { buffer: n, attr: s, count: r }
    );
  }
  function N(t, i, e, r, a) {
    var n = t.getUniformLocation(r, i);
    return (
      0 > n && console.log('无法获取 uniform 变量的存储位置'),
      (function(t, i, e, r) {
        switch (r) {
          case 'float':
            t.uniform1f(i, e);
            break;
          case 'vec2':
            t.uniform2fv(i, e);
            break;
          case 'vec3':
            t.uniform3fv(i, e);
            break;
          case 'vec4':
            t.uniform4fv(i, e);
            break;
          case 'bool':
            t.uniform1i(i, e);
            break;
          case 'sampler2d':
            break;
          case 'mat4':
            t.uniformMatrix4fv(i, !1, e);
        }
      })(t, n, e, a),
      n
    );
  }
  var j = (function(t) {
    n(r, t);
    var i = l(r);
    function r(t) {
      var a;
      return (
        e(this, r),
        ((a = i.call(this, t)).indices = void 0),
        (a.indicesBuffer = void 0),
        (a.vertices = void 0),
        (a.colors = void 0),
        (a.uvs = void 0),
        a
      );
    }
    return r;
  })(T);
  var G = (function(t) {
      n(r, t);
      var i = l(r);
      function r(t) {
        var a;
        return (
          e(this, r),
          ((a = i.call(this, t)).type = 'PlaneMesh'),
          (a.scene = void 0),
          (a.camera = void 0),
          (a.color = void 0),
          (a.material = new L({})),
          (a.width = 1),
          (a.height = 1),
          (a.imgLoading = !1),
          (a.shaderAttributes = void 0),
          (a.texture = void 0),
          void 0 !== t.material && (a.material = t.material),
          void 0 !== t.width && (a.width = t.width),
          void 0 !== t.height && (a.height = t.height),
          (a.shaderAttributes = []),
          a
        );
      }
      return (
        a(r, [
          {
            key: 'init',
            value: function(t, i) {
              var e, r, a;
              (this.gl = t),
                (this.camera = i),
                (this.cameraDistance = b(i.position, this.position)),
                this.material.init(this.gl),
                (this.program = I(
                  this.gl,
                  this.getRectVSHADER(),
                  this.getRectFSHADER(),
                )),
                this.gl.useProgram(this.program),
                (this.vertices =
                  ((r = this.width),
                  (a = this.height),
                  new Float32Array([
                    -r / 2,
                    a / 2,
                    -r / 2,
                    -a / 2,
                    r / 2,
                    a / 2,
                    r / 2,
                    -a / 2,
                  ]))),
                (this.uvs = new Float32Array([0, 1, 0, 0, 1, 1, 1, 0])),
                (this.color = new P(
                  null == this || null === (e = this.material) || void 0 === e
                    ? void 0
                    : e.color,
                )),
                this.setUnifroms(),
                this.shaderAttributes.push(
                  H(this.gl, 'a_Position', this.vertices, 2, this.program),
                ),
                this.shaderAttributes.push(
                  H(this.gl, 'a_TextCoord', this.uvs, 2, this.program),
                ),
                this.gl.useProgram(null);
            },
          },
          {
            key: 'setCamera',
            value: function(t) {
              this.camera = t;
            },
          },
          {
            key: 'setUnifroms',
            value: function() {
              var t, i;
              (this.projMatrix = this.camera.getPerspectiveMatrix()),
                N(
                  this.gl,
                  'u_projMatrix',
                  this.projMatrix,
                  this.program,
                  'mat4',
                ),
                (this.viewMatrix = this.camera.getViewMatrix()),
                N(
                  this.gl,
                  'u_viewMatrix',
                  this.viewMatrix,
                  this.program,
                  'mat4',
                ),
                N(
                  this.gl,
                  'u_modelMatrix',
                  this.modelMatrix,
                  this.program,
                  'mat4',
                ),
                N(
                  this.gl,
                  'u_opacity',
                  void 0 !==
                    (null == this ||
                    null === (t = this.material) ||
                    void 0 === t
                      ? void 0
                      : t.opacity)
                    ? null == this ||
                      null === (i = this.material) ||
                      void 0 === i
                      ? void 0
                      : i.opacity
                    : 1,
                  this.program,
                  'float',
                ),
                N(
                  this.gl,
                  'u_color',
                  this.color.getRGB(),
                  this.program,
                  'vec3',
                );
            },
          },
          {
            key: 'updateAttributeUnifroms',
            value: function() {
              var t = this;
              if (
                (this.shaderAttributes.map(function(i) {
                  var e = i.attr,
                    r = i.count;
                  t.gl.bindBuffer(t.gl.ARRAY_BUFFER, i.buffer),
                    t.gl.vertexAttribPointer(e, r, t.gl.FLOAT, !1, 0, 0),
                    t.gl.bindBuffer(t.gl.ARRAY_BUFFER, null);
                }),
                this.setUnifroms(),
                this.texture)
              ) {
                this.gl.bindTexture(this.gl.TEXTURE_2D, this.texture);
                var i = this.gl.getUniformLocation(this.program, 'u_Sampler');
                this.gl.uniform1i(i, 0);
              }
            },
          },
          {
            key: 'draw',
            value: function(t) {
              !this.imgLoading &&
                t &&
                (this.gl.useProgram(this.program),
                this.setCamera(t),
                this.updateAttributeUnifroms(),
                this.gl.drawArrays(this.gl.TRIANGLE_STRIP, 0, 4));
            },
          },
          {
            key: 'getRectVSHADER',
            value: function() {
              return '\n            uniform mat4 u_projMatrix;\n            uniform mat4 u_viewMatrix;\n            uniform mat4 u_modelMatrix;\n\n            attribute vec4 a_Position;\n            attribute vec2 a_TextCoord;\n            varying vec2 v_uv;\n            void main(){\n                v_uv = a_TextCoord;\n\n                gl_Position = u_projMatrix * u_viewMatrix *  u_modelMatrix * a_Position;\n           \n            }\n        ';
            },
          },
          {
            key: 'getRectFSHADER',
            value: function() {
              var t,
                i = this,
                e = 'gl_FragColor = vec4(u_color, u_opacity);\n',
                r = ['uniform float u_opacity;\n', 'uniform vec3 u_color;'];
              return (
                (null === (t = this.material) || void 0 === t
                  ? void 0
                  : t.map) &&
                  ((this.imgLoading = !0),
                  r.push('uniform sampler2D u_Sampler;\n'),
                  this.material.on('loadImage', function(t) {
                    var e = t.texture;
                    i.gl.useProgram(i.program),
                      (i.texture = e),
                      i.gl.activeTexture(i.gl.TEXTURE0),
                      i.material.texture &&
                        i.gl.bindTexture(i.gl.TEXTURE_2D, e);
                    var r = i.gl.getUniformLocation(i.program, 'u_Sampler');
                    i.gl.uniform1i(r, 0),
                      (i.imgLoading = !1),
                      i.scene && i.scene.renderScene();
                  }),
                  (e = 'gl_FragColor = texture2D(u_Sampler, v_uv);\n')),
                'precision mediump float;\n' +
                  r.join('') +
                  '\n      varying vec2 v_uv;\n      void main(){\n        '.concat(
                    e,
                    '\n        gl_FragColor.a *= u_opacity;\n      }\n      ',
                  )
              );
            },
          },
        ]),
        r
      );
    })(j),
    X = (function(t) {
      n(r, t);
      var i = l(r);
      function r(t) {
        var a;
        return (
          e(this, r),
          ((a = i.call(this, t)).type = 'CubeMesh'),
          (a.material = new L({})),
          (a.shaderAttributes = void 0),
          (a.indices = void 0),
          (a.indicesBuffer = void 0),
          void 0 !== t.material && (a.material = t.material),
          (a.shaderAttributes = []),
          a
        );
      }
      return (
        a(r, [
          {
            key: 'init',
            value: function(t, i) {
              var e;
              (this.gl = t),
                (this.camera = i),
                (this.cameraDistance = b(i.position, this.position)),
                null === (e = this.material) || void 0 === e || e.init(this.gl),
                (this.program = I(
                  this.gl,
                  this.getCubeVSHADER(),
                  this.getCubeFSHADER(),
                )),
                this.gl.useProgram(this.program),
                (this.vertices = new Float32Array([
                  1,
                  1,
                  1,
                  -1,
                  1,
                  1,
                  -1,
                  -1,
                  1,
                  1,
                  -1,
                  1,
                  1,
                  -1,
                  -1,
                  1,
                  1,
                  -1,
                  -1,
                  1,
                  -1,
                  -1,
                  -1,
                  -1,
                  1,
                  1,
                  -1,
                  1,
                  1,
                  1,
                  1,
                  -1,
                  1,
                  1,
                  -1,
                  -1,
                  -1,
                  1,
                  -1,
                  -1,
                  1,
                  1,
                  1,
                  1,
                  1,
                  1,
                  1,
                  -1,
                  1,
                  -1,
                  1,
                  -1,
                  -1,
                  1,
                  -1,
                  -1,
                  -1,
                  1,
                  -1,
                  -1,
                  -1,
                  1,
                  1,
                  -1,
                  1,
                  -1,
                  -1,
                  -1,
                  -1,
                  -1,
                  -1,
                  1,
                ])),
                (this.colors = new Float32Array([
                  1,
                  1,
                  1,
                  1,
                  1,
                  1,
                  1,
                  1,
                  1,
                  1,
                  1,
                  1,
                  0,
                  1,
                  1,
                  0,
                  1,
                  1,
                  0,
                  1,
                  1,
                  0,
                  1,
                  1,
                  1,
                  1,
                  0,
                  1,
                  1,
                  0,
                  1,
                  1,
                  0,
                  1,
                  1,
                  0,
                  1,
                  0,
                  0,
                  1,
                  0,
                  0,
                  1,
                  0,
                  0,
                  1,
                  0,
                  0,
                  0,
                  1,
                  0,
                  0,
                  1,
                  0,
                  0,
                  1,
                  0,
                  0,
                  1,
                  0,
                  0,
                  0,
                  1,
                  0,
                  0,
                  1,
                  0,
                  0,
                  1,
                  0,
                  0,
                  1,
                ])),
                (this.indices = new Uint8Array([
                  0,
                  1,
                  2,
                  0,
                  2,
                  3,
                  6,
                  5,
                  4,
                  6,
                  4,
                  7,
                  8,
                  9,
                  10,
                  8,
                  10,
                  11,
                  12,
                  13,
                  14,
                  12,
                  14,
                  15,
                  16,
                  17,
                  18,
                  16,
                  18,
                  19,
                  20,
                  21,
                  22,
                  20,
                  22,
                  23,
                ])),
                this.setUnifroms(),
                this.shaderAttributes.push(
                  H(this.gl, 'a_Position', this.vertices, 3, this.program),
                ),
                this.shaderAttributes.push(
                  H(this.gl, 'a_Color', this.colors, 3, this.program),
                ),
                (this.indicesBuffer = (function(t, i) {
                  var e = t.createBuffer();
                  return (
                    e || console.log('failed create vertex buffer'),
                    t.bindBuffer(t.ELEMENT_ARRAY_BUFFER, e),
                    t.bufferData(t.ELEMENT_ARRAY_BUFFER, i, t.STATIC_DRAW),
                    e
                  );
                })(this.gl, this.indices));
            },
          },
          {
            key: 'setCamera',
            value: function(t) {
              this.camera = t;
            },
          },
          {
            key: 'setUnifroms',
            value: function() {
              (this.projMatrix = this.camera.getPerspectiveMatrix()),
                N(
                  this.gl,
                  'u_projMatrix',
                  this.projMatrix,
                  this.program,
                  'mat4',
                ),
                (this.viewMatrix = this.camera.getViewMatrix()),
                N(
                  this.gl,
                  'u_viewMatrix',
                  this.viewMatrix,
                  this.program,
                  'mat4',
                ),
                N(
                  this.gl,
                  'u_modelMatrix',
                  this.modelMatrix,
                  this.program,
                  'mat4',
                );
            },
          },
          {
            key: 'updateAttributeUnifroms',
            value: function() {
              var t = this;
              if (
                (this.indices &&
                  this.indicesBuffer &&
                  (this.gl.bindBuffer(
                    this.gl.ELEMENT_ARRAY_BUFFER,
                    this.indicesBuffer,
                  ),
                  this.gl.bufferData(
                    this.gl.ELEMENT_ARRAY_BUFFER,
                    this.indices,
                    this.gl.STATIC_DRAW,
                  )),
                this.shaderAttributes.map(function(i) {
                  var e = i.attr,
                    r = i.count;
                  t.gl.bindBuffer(t.gl.ARRAY_BUFFER, i.buffer),
                    t.gl.vertexAttribPointer(e, r, t.gl.FLOAT, !1, 0, 0),
                    t.gl.bindBuffer(t.gl.ARRAY_BUFFER, null);
                }),
                this.setUnifroms(),
                this.texture)
              ) {
                this.gl.bindTexture(this.gl.TEXTURE_2D, this.texture);
                var i = this.gl.getUniformLocation(this.program, 'u_Sampler');
                this.gl.uniform1i(i, 0);
              }
            },
          },
          {
            key: 'draw',
            value: function(t) {
              this.gl.useProgram(this.program),
                this.setCamera(t),
                this.updateAttributeUnifroms(),
                this.gl.drawElements(
                  this.gl.TRIANGLES,
                  this.indices.length,
                  this.gl.UNSIGNED_BYTE,
                  0,
                );
            },
          },
          {
            key: 'getCubeVSHADER',
            value: function() {
              return '\n            uniform mat4 u_projMatrix;\n            uniform mat4 u_viewMatrix;\n            uniform mat4 u_modelMatrix;\n\n            attribute vec4 a_Position;\n            attribute vec4 a_Color;\n\n            varying vec4 v_Color;\n            void main(){\n                v_Color = a_Color;\n\n                gl_Position = u_projMatrix * u_viewMatrix *  u_modelMatrix * a_Position;\n           \n            }\n        ';
            },
          },
          {
            key: 'getCubeFSHADER',
            value: function() {
              return '\n            #ifdef GL_ES\n            precision mediump float;\n            #endif\n            varying vec4 v_Color;\n            void main(){\n                gl_FragColor = v_Color;\n                // gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n            }\n        ';
            },
          },
        ]),
        r
      );
    })(j),
    V = (function(t) {
      n(r, t);
      var i = l(r);
      function r(t) {
        var a;
        return (
          e(this, r),
          ((a = i.call(this, t)).scene = void 0),
          (a.camera = void 0),
          (a.imgLoading = !1),
          (a.texture = void 0),
          (a.material = new L({})),
          (a.geometry = void 0),
          (a.shaderAttributes = []),
          (a.color = void 0),
          void 0 !== t.material && (a.material = t.material),
          (a.geometry = t.geometry),
          a
        );
      }
      return (
        a(r, [
          {
            key: 'init',
            value: function(t, i) {
              var e;
              (this.gl = t),
                (this.camera = i),
                (this.cameraDistance = b(i.position, this.position)),
                this.material.init(this.gl),
                (this.program = I(
                  this.gl,
                  this.getRectVSHADER(),
                  this.getRectFSHADER(),
                )),
                this.gl.useProgram(this.program);
              var r = this.geometry.vertices,
                a = this.geometry.uvs;
              (this.color = new P(
                null == this || null === (e = this.material) || void 0 === e
                  ? void 0
                  : e.color,
              )),
                this.setUnifroms(),
                this.shaderAttributes.push(
                  H(this.gl, 'a_Position', r, 2, this.program),
                ),
                this.shaderAttributes.push(
                  H(this.gl, 'a_TextCoord', a, 2, this.program),
                ),
                this.gl.useProgram(null);
            },
          },
          {
            key: 'draw',
            value: function(t) {
              console.log('draw'),
                !this.imgLoading && t && this.gl.useProgram(this.program);
            },
          },
          {
            key: 'setUnifroms',
            value: function() {
              var t, i;
              (this.projMatrix = this.camera.getPerspectiveMatrix()),
                N(
                  this.gl,
                  'u_projMatrix',
                  this.projMatrix,
                  this.program,
                  'mat4',
                ),
                (this.viewMatrix = this.camera.getViewMatrix()),
                N(
                  this.gl,
                  'u_viewMatrix',
                  this.viewMatrix,
                  this.program,
                  'mat4',
                ),
                N(
                  this.gl,
                  'u_modelMatrix',
                  this.modelMatrix,
                  this.program,
                  'mat4',
                ),
                N(
                  this.gl,
                  'u_opacity',
                  void 0 !==
                    (null == this ||
                    null === (t = this.material) ||
                    void 0 === t
                      ? void 0
                      : t.opacity)
                    ? null == this ||
                      null === (i = this.material) ||
                      void 0 === i
                      ? void 0
                      : i.opacity
                    : 1,
                  this.program,
                  'float',
                ),
                N(
                  this.gl,
                  'u_color',
                  this.color.getRGB(),
                  this.program,
                  'vec3',
                );
            },
          },
          {
            key: 'getRectVSHADER',
            value: function() {
              return '\n            uniform mat4 u_projMatrix;\n            uniform mat4 u_viewMatrix;\n            uniform mat4 u_modelMatrix;\n\n            attribute vec4 a_Position;\n            attribute vec2 a_TextCoord;\n            varying vec2 v_uv;\n            void main(){\n                v_uv = a_TextCoord;\n\n                gl_Position = u_projMatrix * u_viewMatrix *  u_modelMatrix * a_Position;\n           \n            }\n        ';
            },
          },
          {
            key: 'getRectFSHADER',
            value: function() {
              var t,
                i,
                e = this,
                r = 'gl_FragColor = vec4(u_color, u_opacity);\n',
                a = ['uniform float u_opacity;\n', 'uniform vec3 u_color;'];
              (null == this || null === (t = this.material) || void 0 === t
                ? void 0
                : t.map) &&
                ((this.imgLoading = !0),
                a.push('uniform sampler2D u_Sampler;\n'),
                null === (i = this.material) ||
                  void 0 === i ||
                  i.on('loadImage', function(t) {
                    var i = t.texture;
                    e.gl.useProgram(e.program),
                      (e.texture = i),
                      e.gl.activeTexture(e.gl.TEXTURE0),
                      e.material.texture &&
                        e.gl.bindTexture(e.gl.TEXTURE_2D, i);
                    var r = e.gl.getUniformLocation(e.program, 'u_Sampler');
                    e.gl.uniform1i(r, 0),
                      (e.imgLoading = !1),
                      e.scene && e.scene.renderScene();
                  }),
                (r = 'gl_FragColor = texture2D(u_Sampler, v_uv);\n'));
              return (
                'precision mediump float;\n' +
                a.join('') +
                '\n      varying vec2 v_uv;\n      void main(){\n        '.concat(
                  r,
                  '\n        gl_FragColor.a *= u_opacity;\n      }\n      ',
                )
              );
            },
          },
        ]),
        r
      );
    })(T),
    Y = (function() {
      function t(i) {
        e(this, t), (this.gl = void 0), (this.shaderAttributes = []);
      }
      return (
        a(t, [
          {
            key: 'init',
            value: function(t) {
              this.gl = t;
              var i = (function(t) {
                var i = t.drawingBufferHeight,
                  e = R(t.drawingBufferWidth),
                  r = R(i),
                  a = t.createFramebuffer();
                t.bindFramebuffer(t.FRAMEBUFFER, a);
                var n = t.createRenderbuffer();
                t.bindRenderbuffer(t.RENDERBUFFER, n),
                  t.renderbufferStorage(
                    t.RENDERBUFFER,
                    t.DEPTH_COMPONENT16,
                    e,
                    r,
                  ),
                  t.framebufferRenderbuffer(
                    t.FRAMEBUFFER,
                    t.DEPTH_ATTACHMENT,
                    t.RENDERBUFFER,
                    n,
                  );
                var s = t.createTexture();
                return (
                  (a.texture = s),
                  (a.width = e),
                  (a.height = r),
                  t.bindTexture(t.TEXTURE_2D, s),
                  t.texParameteri(
                    t.TEXTURE_2D,
                    t.TEXTURE_MAG_FILTER,
                    t.NEAREST,
                  ),
                  t.texParameteri(
                    t.TEXTURE_2D,
                    t.TEXTURE_MIN_FILTER,
                    t.NEAREST,
                  ),
                  t.texImage2D(
                    t.TEXTURE_2D,
                    0,
                    t.RGBA,
                    e,
                    r,
                    0,
                    t.RGBA,
                    t.UNSIGNED_BYTE,
                    null,
                  ),
                  t.framebufferTexture2D(
                    t.FRAMEBUFFER,
                    t.COLOR_ATTACHMENT0,
                    t.TEXTURE_2D,
                    s,
                    0,
                  ),
                  t.bindTexture(t.TEXTURE_2D, null),
                  t.bindFramebuffer(t.FRAMEBUFFER, null),
                  {
                    FRAMEBUFFER: a,
                    OFFER_SCREEN_WIDTH: e,
                    OFFER_SCREEN_HEIGHT: r,
                  }
                );
              })(this.gl);
              (this.framebuffer = i.FRAMEBUFFER),
                (this.v =
                  '\n            attribute vec4 a_Position;\n            attribute vec2 a_TextCoord;\n            varying vec2 v_TexCoord;\n\n            void main(){\n                gl_Position = a_Position;\n                v_TexCoord = a_TextCoord;\n            }\n        '),
                (this.f =
                  '\n            precision mediump float;\n\n            uniform sampler2D u_Sampler;\n            varying vec2 v_TexCoord;\n\n            void main(){\n                // https://www.cnblogs.com/zhangjiansheng/p/6925722.html\n                // Gray = (R*38 + G*75 + B*15) >> 7\n                // Gray = R*0.299 + G*0.587 + B*0.114\n                vec4 screenPixels = texture2D(u_Sampler, v_TexCoord);\n\n                float R = screenPixels.r;\n                float G = screenPixels.g;\n                float B = screenPixels.b;\n                float gray = R*0.299 + G*0.587 + B*0.114;\n            \n                gl_FragColor = vec4(vec3(gray), 1.0);\n            }'),
                (this.rectVertices = new Float32Array([
                  -1,
                  1,
                  -1,
                  -1,
                  1,
                  1,
                  1,
                  -1,
                ])),
                (this.rectUvs = new Float32Array([0, 1, 0, 0, 1, 1, 1, 0])),
                (this.program = I(this.gl, this.v, this.f)),
                this.gl.useProgram(this.program);
              var e = H(
                  this.gl,
                  'a_Position',
                  this.rectVertices,
                  2,
                  this.program,
                ),
                r = e.attr,
                a = e.count;
              (this.posBuffer = e.buffer),
                (this.pAttr = r),
                (this.posCount = a);
              var n = H(this.gl, 'a_TextCoord', this.rectUvs, 2, this.program),
                s = n.count;
              (this.texBuffer = n.buffer),
                (this.texCount = s),
                this.gl.activeTexture(this.gl.TEXTURE0);
              var o = this.gl.getUniformLocation(this.program, 'u_Sampler');
              this.gl.uniform1i(o, 0);
            },
          },
          {
            key: 'drawPass',
            value: function() {
              this.gl.clear(
                this.gl.COLOR_BUFFER_BIT | this.gl.DEPTH_BUFFER_BIT,
              ),
                this.gl.useProgram(this.program),
                this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.posBuffer),
                this.gl.vertexAttribPointer(
                  this.pAttr,
                  this.posCount,
                  this.gl.FLOAT,
                  !1,
                  0,
                  0,
                ),
                this.gl.bindBuffer(this.gl.ARRAY_BUFFER, null),
                this.gl.bindTexture(
                  this.gl.TEXTURE_2D,
                  this.framebuffer.texture,
                ),
                this.gl.drawArrays(this.gl.TRIANGLE_STRIP, 0, 4),
                this.gl.bindTexture(this.gl.TEXTURE_2D, null);
            },
          },
        ]),
        t
      );
    })();
  (t.BasicMaterial = L),
    (t.BoxGeometry = X),
    (t.Camera = F),
    (t.Color = P),
    (t.GrayPass = Y),
    (t.Mesh = V),
    (t.PlaneGeometry = G),
    (t.Renderer = B),
    (t.Scene = A),
    Object.defineProperty(t, '__esModule', { value: !0 });
});
//# sourceMappingURL=renderer.min.js.map
